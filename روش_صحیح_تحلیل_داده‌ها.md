# 📊 راهنمای روش صحیح تحلیل داده‌های تولید

## 🎯 مشکل اصلی

در فایل اکسل داده‌ها:
- **هر ردیف = یک توقف**
- **داده‌های تولید تکراری هستند** (برای جلوگیری از خالی بودن سلول‌ها)

### مثال:
اگر در یک شیفت 5 توقف اتفاق بیفتد، 5 ردیف خواهیم داشت که در همه آنها داده‌های تولید (تناژ، تعداد سرویس، ...) تکرار شده‌اند.

## ❌ مشکل روش قدیمی

```dart
// روش قدیمی - دوباره‌شماری دارد
for (var item in allData) {
    totalProduction += item.producedProduct;  // ❌ اشتباه!
    totalStops += 1;                          // ✅ درست
}
```

**نتیجه**: آمار تولید چندبرابر واقعی محاسبه می‌شود!

## ✅ راه‌حل صحیح

```dart
// برای تولید: فقط یک ردیف از هر شیفت
final uniqueData = ProductionAnalysisService.getUniqueProductionData(allData);
for (var item in uniqueData) {
    totalProduction += item.producedProduct;  // ✅ درست!
}

// برای توقفات: همه ردیف‌ها
final stopData = ProductionAnalysisService.getAllStopData(allData);
for (var item in stopData) {
    totalStops += 1;                          // ✅ درست!
}
```

## 🛠️ نحوه استفاده از ProductionAnalysisService

### 1. آمار تولید صحیح

```dart
import '../services/production_analysis_service.dart';

// محاسبه آمار تولید (بدون دوباره‌شماری)
final productionStats = ProductionAnalysisService.calculateProductionStatistics(data);

print('تولید کل: ${productionStats['totalProducedProduct']} تن');
print('تعداد شیفت‌ها: ${productionStats['shiftsCount']}');
print('راندمان میانگین: ${productionStats['averageEfficiency']}%');
```

### 2. آمار توقفات کامل

```dart
// محاسبه آمار توقفات (همه رکوردها)
final stopStats = ProductionAnalysisService.calculateStopStatistics(data);

print('کل توقفات: ${stopStats['totalStops']} مورد');
print('مدت کل: ${ProductionAnalysisService.formatDuration(stopStats['totalStopDuration'])}');
print('توقفات اضطراری: ${stopStats['emergencyStops']} مورد');
```

### 3. آمار ترکیبی

```dart
// محاسبه همه آمارها با یک تابع
final combinedStats = ProductionAnalysisService.calculateCombinedStatistics(data);

final production = combinedStats['production'];
final stops = combinedStats['stops'];
final summary = combinedStats['summary'];
```

### 4. آمار تجهیز خاص

```dart
// آمار یک تجهیز خاص
final equipmentStats = ProductionAnalysisService.getEquipmentStatistics(data, 'خط 1');

// آمار یک شیفت خاص
final shiftStats = ProductionAnalysisService.getShiftStatistics(data, 1);

// آمار یک روز خاص
final dailyStats = ProductionAnalysisService.getDailyStatistics(data, '1403/01/15');
```

### 5. برترین تجهیزات

```dart
// برترین تجهیزات از نظر تولید
final topProduction = ProductionAnalysisService.getTopEquipmentsByProduction(data);
for (var item in topProduction.take(5)) {
    print('${item['equipment']}: ${item['production']} تن');
}

// تجهیزات با بیشترین توقف
final topStops = ProductionAnalysisService.getTopEquipmentsByStops(data);
for (var item in topStops.take(5)) {
    print('${item['equipment']}: ${item['stops']} توقف');
}
```

## 🔧 تابع‌های کمکی

### فرمت‌بندی اعداد

```dart
// فرمت فارسی با جداکننده
String formatted = ProductionAnalysisService.formatNumber(1234567.89);
// نتیجه: "1,234,567.89"
```

### فرمت مدت زمان

```dart
// تبدیل دقیقه به ساعت:دقیقه
String duration = ProductionAnalysisService.formatDuration(135);
// نتیجه: "02:15"
```

## 📊 مقایسه روش‌ها

برای مشاهده تفاوت روش‌ها:

1. از منوی اصلی برنامه
2. روی آیکن منو (3 نقطه) کلیک کنید
3. گزینه "مقایسه روش‌های محاسبه" را انتخاب کنید

## 🎯 کاربرد در صفحات

### ProductionScreen

```dart
// در ProductionScreen
final uniqueData = ProductionAnalysisService.getUniqueProductionData(allData);
final stats = ProductionAnalysisService.calculateProductionStatistics(allData);

// نمایش آمار صحیح
Text('تولید کل: ${ProductionAnalysisService.formatNumber(stats['totalProducedProduct'])} تن');
```

### StopsScreen

```dart
// در StopsScreen
final stopData = ProductionAnalysisService.getAllStopData(allData);
final stats = ProductionAnalysisService.calculateStopStatistics(allData);

// نمایش آمار توقفات
Text('کل توقفات: ${stats['totalStops']} مورد');
```

## ⚠️ نکات مهم

### 1. گروه‌بندی شیفت‌ها

سرویس بر اساس کلید زیر گروه‌بندی می‌کند:
```
'تاریخ_شیفت_تجهیز' -> '1403/01/15_1_خط 1'
```

### 2. انتخاب نماینده شیفت

از هر شیفت، **اولین ردیف** انتخاب می‌شود. می‌توانید تغییر دهید:

```dart
// در getUniqueProductionData()
var representative = shiftData.first;        // اولین ردیف
// یا
var representative = shiftData.last;         // آخرین ردیف
// یا
var representative = shiftData.reduce((a, b) => 
    a.producedProduct > b.producedProduct ? a : b);  // بیشترین تولید
```

### 3. فیلتر داده‌های تولید

فقط ردیف‌هایی که داده تولید واقعی دارند انتخاب می‌شوند:

```dart
if (representative.inputTonnage > 0 || 
    representative.scale3 > 0 || 
    representative.scale4 > 0 || 
    representative.scale5 > 0 ||
    representative.serviceCount > 0) {
  uniqueData.add(representative);
}
```

### 4. فیلتر داده‌های توقف

فقط ردیف‌هایی که توقف واقعی دارند انتخاب می‌شوند:

```dart
item.stopType.isNotEmpty && 
item.stopReason.isNotEmpty &&
item.stopDurationMinutes > 0
```

## 🚀 مزایای روش جدید

1. ✅ **دقت بالا**: حذف دوباره‌شماری
2. ✅ **کارایی بهتر**: محاسبه بهینه
3. ✅ **انعطاف‌پذیر**: قابلیت فیلتر و تحلیل
4. ✅ **قابل اعتماد**: آمار واقعی و صحیح
5. ✅ **مقیاس‌پذیر**: سازگار با حجم بالای داده

## 📝 مثال کامل

```dart
// در یک صفحه یا ویجت
class MyAnalysisWidget extends StatelessWidget {
  final List<ProductionData> data;

  @override
  Widget build(BuildContext context) {
    // آمار کامل
    final stats = ProductionAnalysisService.calculateCombinedStatistics(data);
    final production = stats['production'];
    final stops = stats['stops'];
    
    return Column(
      children: [
        Text('تولید: ${ProductionAnalysisService.formatNumber(production['totalProducedProduct'])} تن'),
        Text('توقفات: ${stops['totalStops']} مورد'),
        Text('راندمان: ${production['averageEfficiency'].toStringAsFixed(1)}%'),
      ],
    );
  }
}
```

---

## 📞 پشتیبانی

اگر سوالی داشتید یا مشکلی پیش آمد:

1. ابتدا صفحه "مقایسه روش‌ها" را بررسی کنید
2. مستندات کد در `ProductionAnalysisService` را مطالعه کنید
3. در صورت نیاز اطلاع دهید

**موفق باشید!** 🎊 